name: ğŸš€ Deploy BorsaItalianaAlertBot su VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: âš™ï¸ Deploy su VPS
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¦ Clona il repository
        uses: actions/checkout@v4

      - name: ğŸš€ Deploy via SSH al VPS (con riavvio Container solo se necessario)
        run: |
          echo "ğŸ“¦ Installo sshpass..."
          sudo apt-get update && sudo apt-get install -y sshpass

          echo "ğŸ” Connessione SSH al VPS..."
          sshpass -p "${{ secrets.VPS_PASSWORD }}" ssh -o StrictHostKeyChecking=no "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" << 'EOF'
            
            echo "ğŸ“ [1/4] Verifico/creo la cartella del progetto..."
            if [ ! -d "/root/BorsaItalianaAlert" ]; then
              git clone https://github.com/miketester10/BorsaItalianaAlert.git /root/BorsaItalianaAlert
            fi
            cd /root/BorsaItalianaAlert

            echo "ğŸ“¥ [2/4] Eseguo git pull..."
            OUTPUT=$(git pull origin main)

            echo "ğŸ” Verifico se ci sono modifiche..."
            if [[ "$OUTPUT" == *"Already up to date."* ]]; then
              echo "â„¹ï¸ Nessuna modifica trovata, il container non verrÃ  riavviato."
            else
              echo "âœ… Modifiche trovate:"
              echo "$OUTPUT"

              echo "ğŸ›‘ [3/4] Stop del container esistente..."
              docker compose stop || true

              echo "â–¶ï¸ [4/4] Avvio del container aggiornato..."
              docker compose up -d

              echo "ğŸ‰ Deploy completato con successo!"
            fi
          EOF
