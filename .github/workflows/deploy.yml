name: ðŸš€ Deploy BorsaItalianaAlertBot su VPS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    name: âš™ï¸ Deploy su VPS
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¦ Clona il repository
        uses: actions/checkout@v4

      - name: ðŸš€ Deploy via SSH al VPS con KEY_PEM (con riavvio Container solo se necessario)
        run: |
          echo "ðŸ” Scrivo la chiave privata..."
          echo "${{ secrets.VPS_PEM_BASE64 }}" | base64 -d > vps_key.pem
          chmod 600 vps_key.pem

          echo "ðŸ“¦ Connessione SSH al VPS..."
          ssh -i ./vps_key.pem -o StrictHostKeyChecking=no "${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}" << 'EOF'
            PROJECT_DIR="/home/ubuntu/BorsaItalianaAlert"

            echo "ðŸ“ [1/4] Verifico/creo la cartella del progetto..."
            if [ ! -d "$PROJECT_DIR" ]; then
              git clone https://github.com/miketester10/BorsaItalianaAlert.git "$PROJECT_DIR"
            fi
            cd "$PROJECT_DIR"

            echo "ðŸ“¥ [2/4] Eseguo git pull..."
            OUTPUT=$(git pull origin main)

            echo "ðŸ” Verifico se ci sono modifiche..."
            if [[ "$OUTPUT" == *"Already up to date."* ]]; then
              echo "â„¹ï¸ Nessuna modifica trovata, il container non verrÃ  riavviato."
            else
              echo "âœ… Modifiche trovate:"
              echo "$OUTPUT"

              echo "ðŸ›‘ [3/4] Stop del container esistente..."
              docker compose stop || true

              echo "â–¶ï¸ [4/4] Avvio del container aggiornato..."
              docker compose up -d

              echo "ðŸŽ‰ Deploy completato con successo!"
            fi
          EOF
